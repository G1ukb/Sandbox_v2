<h1> Lambda </h1>

[//]:# (Lambdas vs. ec2)

<details>
    <summary>
        <b><big><big>
            Lambdas vs. ec2?
        </big></big></b>
    </summary>

Виртуальные функции — никаких серверов для управления!
- Ограничено по времени - короткие исполнения 
- Запускать по требованию (лямбда запускается только тогда, когда необходима)
- Масштабирование автоматизировано! 
(В случае необходимости можно настроить автоматическую масштабируемость)
- Интеграция со всем набором сервисов AWS.
- Интегрирован со многими языками программирования
- Простой мониторинг с помощью AWS CloudWatch.
- Легко получить больше ресурсов для каждой функции (до 10 ГБ ОЗУ!)
- Увеличение оперативной памяти также улучшит работу процессора и сети!

</details>
<br>

[//]:# (What ways of triggering a Lambda do you know?)

<details>
    <summary>
        <b><big><big>
            What ways of triggering a Lambda do you know?
        </big></big></b>
    </summary>

Функции Lambda можно активировать разными способами:
- HTTP-запросом
  (При этом HTTP запрос может содержать несколько заголовков значения.
  Для этого настраивается APL (application load balancer) которые будет конвертировать
  ...?name=one&name=two --> {"name":["one,"two"]})
- загрузкой нового документа в S3 (действие, загрузка определенного вайла по маске и т.д.)
- запланированным заданием (с помощью EventBridge (например раз в минуту))
- потоком данных AWS Kinesis
- Event Source Mapping for SQS & SQS FIFO
- уведомлением от AWS SNS

</details>  
<br>

[//]:# (What is Lambda@Edge?)

<details>
    <summary>
        <b><big><big>
            What is Lambda@Edge?
        </big></big></b>
    </summary>

Lambda@Edge - глобальная функция которая интегрируется вместе с CDN CloudFront и помогает
обрабатывать и изменять запросы и ответы на лету.

**Преимущества:**
- Вы можете использовать Lambda для изменения запросов и ответов CloudFront
- Вы также можете генерировать ответы зрителям, даже не отправляя запрос источнику
- Работает как глобальная AWS Lambda не зависящая от региона
- Создание более отзывчивого приложение
- Настройка содержимого request и response

**Как это работает:**
Клиент <---> CloudFront <---> Приложение
CloudFront выступает как прокси и позволяет перехватить и изменить любой req и resp

**Варианты использования**
- Безопасность и конфиденциальность веб-сайта
- Динамическое веб-приложение 
- Поисковая оптимизация (SEO) 
- Интеллектуальная маршрутизация между источниками и центрами обработки данных 
- Предотвращение ботов в конечной точке 
- Преобразование изображений в реальном времени 
- A/B-тестирование
- Аутентификация и авторизация пользователей
- Приоритизация пользователей 
- Отслеживание пользователей и аналитика

</details>
<br>

[//]:# (What is Lambda – Event Source Mapping for SQS & SQS FIFO? Lambda event trigger)

<details>
    <summary>
        <b><big><big>
            What is Lambda – Event Source Mapping for SQS & SQS FIFO?
        </big></big></b>
    </summary>

Лямбда позволяет автоматически обработать некоторое кол-во сообщение из очередей SQS
и SQS FIFO.

При этом Лямбда будет автоматически масштабироваться при чтении сообщение партиями (1-10) для
более быстрой обработки. 
При возникновении ошибки сообщения отправляются в очередь как отдельные элементы.
(Так же есть настройка очереди недоставленных сообщений, в случае сбоев (DLQ))
Lambda удаляет сообщение из очереди после успешной обработки. 

Может масштабироваться:
- масштабируется по количеству активных групп сообщений.
- может создать до 60 экземпляров в минуту
- одновременно обрабатывать до 1000 пакетов сообщений в минуту

</details>  
<br>

[//]:# (What is Lambda - Directions?)

<details>
    <summary>
        <b><big><big>
            What is Lambda - Directions?
        </big></big></b>
    </summary>

Лямбда предлагает возможность настроить направление (конечные точки) для работы функции
(до отсылки результата реста на клиент)

Работает для асинхронных вызовов предлагая выбрать сценарии для успешных или фейл активностей.

Конечной точной можно выбрать:
- SQS
- SNS
- другая Lambda
- Bus Amazon EventBridge

</details>  
<br>

[//]:# (What is Lambda pricing?)

<details>
    <summary>
        <b><big><big>
            What is Lambda pricing?
        </big></big></b>
    </summary>

Оплата за запросы:
- Первые миллион запросов бесплатны
- 0,20 доллара США за 1 миллион запросов в дальнейшем

Оплата за продолжительность: (с шагом 1 мс)
- 400 000 ГБ-секунд вычислительного времени в месяц БЕСПЛАТНО (если используется 1гб ОЗУ)
- 3 200 000 секунд, если для функции используется 128 МБ ОЗУ 
- После этого 1 доллар США за 600 000 ГБ-секунд.

AWS Lambda очень дешевый и из-за этого очень популярный

</details>
<br>

[//]:# (How is it possible to test Lambda code without actually running it in AWS?)

<details>
    <summary>
        <b><big><big>
            How is it possible to test Lambda code without actually running it in AWS?
        </big></big></b>
    </summary>

С помощью интерфейса командной строки (CLI) AWS SAM
вы можете локально тестировать и «пошагово» отлаживать
свои бессерверные приложения перед их загрузкой в облако AWS

</details>
<br>

[//]:# (What is the difference between synchronous and asynchronous Lambda invocations?)

<details>
    <summary>
        <b><big><big>
            What is the difference between synchronous and asynchronous Lambda invocations?
        </big></big></b>
    </summary>

**При синхронном** вызове вы ждете, пока функция обработает событие
и вернет ответ.

- Клиент отправляет запрос / SDK / CLI --(request)--> Lambda
- Клиент отправляет запрос / SDK / CLI <-(response)-- Lambda
(В том числе если возникла ошибка. Ее обработкой должен заниматься клиент)

**При асинхронном** вызове Lambda ставит событие в очередь для обработки.
В случае возникновения ошибки Lambda пытается повторить событие

(1 минута ожидания 1 раз 2 остальные (всего 3 раза))
Есть четкая настройка действий на успешное и неуспешное выполнение

Асинхронные вызовы позволяют ускорить обработку запроса если вам не нужно ждать результат
(пример вам нужно перебрать 1000 файлов)

**Как это работает**:
При асинхронном вызове любой запрос пользователя будет возвращать ожидаемый результат (например 200)
ДАЖЕ ЕСЛИ на самом деле запрос вызвал ошибку. При возникновении ошибки несколько раз подряд система
обработает запрос и (например отправит сообщение SQS что что-то пошло не так)

</details>
<br>

[//]:# (What is Lambda Environment Variables?)

<details>
    <summary>
        <b><big><big>
            What is Lambda Environment Variables?
        </big></big></b>
    </summary>

Лямбда предлагает возможность настроить параметры окружения на подобии postman реализации

Есть возможность создать переменные типа ключ значения (только тип string)
И работать с ключами, а лямбда будет самостоятельно подставлять указанные значения.

**Чем это полезно:**
- Настройте поведение функции без обновления кода
- Переменные среды доступны для вашего кода
- Lambda Service также добавляет собственные системные переменные среды.
- Полезно хранить секретные параметры (они зашифрованные KMS)
  (Секреты могут быть зашифрованы сервисным ключом Lambda или вашим собственным ключом CMK.)

</details>  
<br>

[//]:# (What is Lambda Logging & Monitoring? Tracing with x-ray?)

<details>
    <summary>
        <b><big><big>
            What is Lambda Logging & Monitoring? Tracing with x-ray?
        </big></big></b>
    </summary>

Лямбда позволяет отслеживать все свои действия с помощью мониторов/логирования/AWS X-Ray
- Вызовы, продолжительность, одновременные выполнения
- Количество ошибок, показатели успеха, дроссели
- Сбои асинхронной доставки
- Скорость итерирования (потоки Kinesis и DynamoDB)

Для X-Ray есть переменные среды (они включаются по умолчанию, но о них удобно знать):
- X_AMZN_TRACE_ID: содержит заголовок трассировки.
- AWS_XRAY_CONTEXT_MISSING: по умолчанию LOG_ERROR.
- AWS_XRAY_DAEMON_ADDRESS: IP_ADDRESS демона X-Ray:PORT

</details>  
<br>

[//]:# (How Lambda can connet VPC & private subnet 
or If Lambda in VPC how it connect to public www?)

<details>
    <summary>
        <b><big><big>
            How Lambda can connet VPC & private subnet 
            or If Lambda in VPC how it connect to public www?
        </big></big></b>
    </summary>

**Если лямбда находится за пределами vpc (virtual private connection)**
- **У нее есть доступ к сети интернет, но нет прямого доступа к VPC**
- Лямбда должна создать ENI (Elastic Network Interface) в подсетях VPC и подключаться через него
- Для этого должна быть явно прописана роль **AWSLambdaVPCAccessExecutionRole**

Выглядит это следующим образом

Lambda ---> [(private subnet) ---> (ENI (Elastic Network Interface))  ---> (Destination (example S3))   ]

**Если лямбда находится в vpc и (virtual private connection)**
- **У нее НЕТ доступа к сети интернет, но ЕСТЬ прямой доступ к компонентам VPC**
- Лямбда может использовать 2 варианта
  - Использовать NAT который будет использовать IGW (InternetGetWay)
    (При этом IGW сможет стучать как за пределы (www) так и во внутренние aws сервисы)
  - **если нужен приватный доступ к aws сервисам** можно воспользоваться VPC Endpoint для того,
  чтобы стучать в aws сервисы приватно

выглядит это следующим образом

[(private subnet) Lambda <---> private s3] -> 
1) [] -> Nat -> IGW -> www (or) aws s3
2) [] -> private VPC endpoint -> aws s3


</details>  
<br>

[//]:# (Lambda Concurrency and Throttling? Cold Start?)

<details>
    <summary>
        <b><big><big>
            Lambda Concurrency and Throttling?
        </big></big></b>
    </summary>

Лямбда позволяет вызывать обработку лямбды до 1000 одновременных исполнений.
- Каждая лямбда функция может ограничить максимальное кол-во обработок (=limit)
- Каждый вызов вызодящий за пределы ограничения будет вызывать ("тротлинг")

**Поведение лямбды при тротлинге**
- **При синхронном вызове** возврат ThrottleError - 429
- **При асинхронном вызове** повтор попытки автоматически через время (максмум до 6 часов)
, затем помещение в DLQ

**Чем опасны лимиты**

Если у вас есть три одновременно работающие лямбда функции и на одну из них поступает сразу 
1000 запросов, то остальные 2 функции будут выивать тротринг до тех пор пока тысяча не будет 
уменьшаться. (ЛИМИТЫ ЗАПРОСОВ ДЕЙСТВУЮ ДЛЯ ВСЕХ ЛЯМБД В СУММЕ)

**Холодный запуск**

Как и в Java когда первый раз запрос обрабатывает хуже потому что нужно первый раз достать ресурсы,
так и в лямбдах может возникнуть данная ситуация.
Для борьбы с этим в лямбда есть **предоставленный параллелизм (provisioned concurrency)**.
лямбда функция вызывается заранее, чтобы предотвратить холодный вызов. 
Все настройки выполняются через **Application Auto Scaling**

</details>  
<br>

[//]:# (Lambda limits?)

<details>
    <summary>
        <b><big><big>
            Lambda limits?
        </big></big></b>
    </summary>

Выполнение:
- Распределение памяти: 128 МБ – 10 ГБ (с шагом 1 МБ)
- Максимальное время выполнения: 900 секунд (15 минут)
- Переменные среды (4 КБ)
- Емкость диска в «контейнере функций» (в /tmp): 512 МБ.
- Параллельные выполнения: 1000 (можно увеличить)

Развертывание:
- Размер развертывания функции Lambda (сжатый ZIP-файл): 50 МБ.
- Размер несжатого развертывания (код + зависимости): 250 МБ.
- Можно использовать каталог /tmp для загрузки других файлов при запуске.
- Размер переменных среды: 4 КБ.

</details>  
<br>