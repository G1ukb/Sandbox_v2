# 1.1 Deploy written code in AWS using existing CI/CD pipelines, processes, and patterns. #

[//]:# (1.Commit code to a repository and invoke build, test and/or deployment actions)

<details>
    <summary>
        <b><big><big>
            1.Commit code to a repository and invoke build, test and/or deployment actions
            <br>(Обзор AWS пайплайна и сервисов которые помогают выстроить грамотный CI/CD)
        </big></big></b>
    </summary>

[ORIGINAL](https://aws.amazon.com/blogs/devops/complete-ci-cd-with-aws-codecommit-aws-codebuild-aws-codedeploy-and-aws-codepipeline)

![](https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2020/09/30/DevOps_feedback-diagram.png)

Сервисы, которые участвуют в CI/CD

1.**AWS CodeCommit** — **(Подключенный гит репозиторий)**
    полностью управляемая служба контроля версий, в которой размещаются защищенные
    репозитории на основе Git. CodeCommit упрощает совместную работу команд над 
    кодом в безопасной и масштабируемой экосистеме. Это решение использует CodeCommit
    для создания репозитория для хранения кода приложения и развертывания.

2.**AWS CodeBuild** — **(Билд, Тест, Создание артефакта)**
    полностью управляемый сервис непрерывной интеграции, который компилирует исходный код, 
   запускает тесты и создает пакеты программного обеспечения, готовые к развертыванию, 
   на динамически создаваемом сервере сборки. Это решение использует CodeBuild 
   для создания и тестирования кода, который мы развертываем позже.

3.**AWS CodeDeploy** — полностью **управляемый сервис развертывания**, 
    который автоматизирует развертывание программного обеспечения в различных вычислительных сервисах, 
   таких как Amazon EC2, AWS Fargate , AWS Lambda и на ваших локальных серверах. 
   Это решение использует CodeDeploy для развертывания кода или приложения в наборе
   экземпляров EC2, на которых запущены агенты CodeDeploy.

4.**AWS CodePipeline** — **(Соединитель CodeCommit/CodeBuild/CodeDeploy)**
   В этом решении используется CodePipeline для создания сквозного конвейера, 
   который извлекает код приложения из CodeCommit, выполняет сборку и тестирование 
   с помощью CodeBuild и, наконец, развертывает с помощью CodeDeploy.

5.**События AWS CloudWatch** — **(триггер срабатывающий на коммиты в гите и запускающий пайплайн)**
   правило AWS CloudWatch Events создается для запуска CodePipeline при фиксации 
   Git в репозитории CodeCommit.

6.**Amazon Simple Storage Service (Amazon S3)** - **хранения артефактов сборки и развертывания**,
   созданных во время выполнения конвейера.

7.**Сервис AWS Key Management Service (AWS KMS)**. - **(для шифрования артефактов)**
   AWS KMS упрощает создание криптографических ключей 
   и управление ими, а также контроль их использования в различных сервисах AWS и в ваших приложениях.
   Это решение использует AWS KMS, чтобы убедиться, что артефакты сборки и развертывания, 
   хранящиеся в корзине S3, зашифрованы в состоянии покоя.

8.**AWS CodeStar** - **Содержит шаблоны быстрой настройки**. Что куда откуда уже задано.
    Вам следует использовать CodeStar всякий раз, когда вы хотите быстро настроить проект разработки 
    программного обеспечения на AWS. AWS CodeStar проведет вас через процесс настройки с помощью шаблонов 
    проектов, которые настраивают реальные приложения и могут быть изменены в любой момент в
    будущем в соответствии с вашими потребностями.

![](https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2020/09/30/Screen-Shot-2020-09-30-at-6.05.53-PM.png)

</details>
<br>

[//]:# (2.Use labels and branches for version and release management)

<details>
    <summary>
        <b><big><big>
            2.Use labels and branches for version and release management
            <br>(Обзор подходов к версианированию CI/CD)
        </big></big></b>
    </summary>

[ORIGINAL](https://aws.amazon.com/blogs/devops/implementing-gitflow-using-aws-codepipeline-aws-codecommit-aws-codebuild-and-aws-codedeploy/)

<h2>**Модели ветвления**</h2>

Есть две популярные модели ветвления, которые клиенты обычно используют в своей организации. 
Один из них основан на **магистрали Trunk-based**, а другой — на основе функций или модели «**GitFlow**».

<h2>**Магистральная разработка**</h2>

Разработка непрерывного CI/CD. 
Рабочая команда делает коммит, он автоматически тестируется и деплоится

- Заказчик постоянно работает с актуальной версией продукта
- Нирвана CI/CD (Автотесты работают сами, артефакт собирается сам, минимальное участие человека)

<h2>**GIT-FLOW разработка**</h2>

GitFlow включает в себя создание нескольких уровней ответвления от мастера, 
где изменения в ветках функций только периодически объединяются на всем пути обратно к мастеру, 
чтобы инициировать выпуск.

<h3>**Когда это может быть нам полезно**:</h3>
- **Не полностью налаженный CI/CD**
- **Несколько команд** могут работать над разными выпусками функций **с разными сроками запуска**.
- **Организации, предоставляющие SAAS** (программное обеспечение как услуга),
  могут иметь **клиентов, которые не хотят постоянно использовать «последнюю» версию**, что вынуждает 
  их создавать несколько веток «Выпуск» и «Исправление».
- У некоторых команд в Организации могут быть **особые требования к QA/UAT**, которые 
  **требуют ручного утверждения**, что может привести к задержке времени с момента введения 
  новой функции до ее выпуска в производство.

<h3>**Рекомендации команды aws, как реализовать Git-flow посредством pipeline** </h3>
- Используйте dev как ветку непрерывной интеграции.
- Используйте feature для работы с несколькими функциями.
- Используйте release для работы над конкретным релизом (несколько функций).
- Используйте hotfix от главной ветки, чтобы отправить исправление.
- Слияние с мастером после каждого выпуска.
- Мастер содержит готовый к производству код.

![](https://static.us-east-1.prod.workshops.aws/public/68da5511-d096-4235-978b-f2e43cee8660/static/images/gitflow-only.png)

<h3>**Инструменты разработчика AWS и GitFlow**</h3>

Создается на все время:
- Master/Dev ветка AWS CodeCommit
- AWS CodeBuild для всех веток
- AWS CodeDeploy для всех веток
- AWS Cloudformation (экземпляр EC2) для мастера (prod) и разработки (stage/dev)

Короткоживущие элементы:
- Feature/Hotfix/Release ветки в AWS CodeCommit
- AWS CodePipeline для временных веток
- AWS CodeDeploy для временных веток
- AWS Cloudformation (экземпляр EC2) для временных веток

![](https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2019/02/12/gitflow-Copy-of-Page-1-1.png)

</details>
<br>

[//]:# (3.Use AWS CodePipeline to orchestrate workflows against different environments)

<details>
    <summary>
        <b><big><big>
            3.Use AWS CodePipeline to orchestrate workflows against different environments
            <br>(Обзор типов развертки)
        </big></big></b>
    </summary>

[ORIGINAL](https://docs.aws.amazon.com/codedeploy/latest/userguide/deployments.html)

В целом, AWS Pipeline самостоятельно имеет возможность совершенно спокойно деплоить 
на несколько енвов сразу. Для этого имеется группа CodeDeploy которая может содержать порядок 
инстансов на которые будет проводить установка разворачиваемых артефактов.

<h3>CodeDeploy предоставляет два варианта типа развертывания: 
**развертывание на месте и сине-зеленое развертывание.**</h3>

<h3>**Развертывание на месте**</h3>
приложение на каждом экземпляре в группе развертывания останавливается, 
устанавливается последняя версия приложения, а новая версия приложения запускается и проверяется.

<h3>**Сине-зеленое развертывание**</h3>
Принцип имеющий в своей основе следующий флоу работы. 
- Подготовка новых енвов/лямбд/ресурсов (установка на них последней версии и прохождение тестов)
- Постепенная замена старых работающих енвов на уже работающие новые /
  в случае лямбд и ресурсов - постепенное перекидывание трафика со старого на новое
- Экземпляры в исходной среде снимаются с учета и могут быть автоматически терминейтнуты 
  или продолжать работу 

На этой диаграмме показан шаблон развертывания в нескольких средах.

![](https://mongodb-devhub-cms.s3.us-west-1.amazonaws.com/aws_codepipeline_161a68794c.png)


</details>
<br>

[//]:# (4.Apply AWS CodeCommit, AWS CodeBuild, AWS CodePipeline, AWS CodeStar, and AWS 
CodeDeploy for CI/CD purposes)

<details>
    <summary>
        <b><big><big>
            4.Apply AWS CodeCommit, AWS CodeBuild, AWS CodePipeline, AWS CodeStar, 
            and AWS CodeDeploy for CI/CD purposes 
            <br>(Обзор порядка и этапов использования сервисов при настройке пайплайна)
        </big></big></b>
    </summary>

[Pinned Guidelines](https://docs.aws.amazon.com/codepipeline/latest/userguide/tutorials.html)

[Guide](https://docs.aws.amazon.com/codepipeline/latest/userguide/tutorials-simple-s3.html)

1. Создание ролей IAM для всех групп пользователей
2. Создание корзины S3 для хранения артефактов
3. Создание инстансов EC2
4. (необязательно) Воспользоваться AWS CodeStar. (выбрать один из предложенных шаблонов.
5. Создать приложение (application) в AWS CodeDeploy и настроить группу добавив EC2 инстанс
   (если потребуется добавление нескольких инстансов, добавляются в группу и 
   отдельно указываются в пайплайне в необходимом для развертки порядке)
6. Создание нового AWS CodePipeline (настроить AWS CodeCommit/CodeBuild) и добавить CodeDeploy

</details>
<br>

[//]:# (5.Perform a roll back plan based on application deployment policy)

<details>
    <summary>
        <b><big><big>
            5. Perform a roll back plan based on application deployment policy
            <br>(Обзор откатов развертывания в зависимости от выбора политики развертывания)
        </big></big></b>
    </summary>

<big>CodeDeploy откатывает развертывания, **повторно развертывая ранее развернутую версию приложения
в качестве нового развертывания**. Эти развертывания с откатом технически являются новыми 
развертываниями с новыми идентификаторами развертывания, а не восстановленными версиями 
предыдущего развертывания.

Развертывания можно откатить автоматически или вручную.</big>

<h3>**Автоматические откаты**</h3>

Вы можете настроить группу развертывания или развертывание для автоматического отката 
в случае сбоя развертывания или при достижении заданного вами порогового значения мониторинга. 
В этом случае развертывается последняя известная исправная версия редакции приложения. 
Вы настраиваете автоматический откат при создании приложения или при создании 
или обновлении группы развертывания.

<h3>**Ручной откат**</h3>
Если вы не настроили автоматический откат, вы можете вручную откатить развертывание, 
создав новое развертывание, в котором используется любая ранее развернутая версия приложения, 
и следуя инструкциям по повторному развертыванию версии.

</details>
<br>
