<h1>Elastic Load Balancing (ELB)</h1>

[//]:# (What is Elastic load balancing [ELB]?)

<details>
    <summary>
        <b><big><big>
            What is Elastic load balancing [ELB]? Why use a load balancer?
        </big></big></b>
    </summary>

Elastic Load Balancer — это управляемый балансировщик нагрузки.
Он помогает балансировать трафик между несколькими нижестоящими инстонсами (например EC2)

**Преимущества**
- Распределите нагрузку между несколькими подчиненными экземплярами
- Предоставляйте единую точку доступа (DNS) для вашего приложения. 
- Беспрепятственно работайте с нижестоящими экземплярами. 
- Регулярно проверяйте работоспособность (хейлчеки) ваших экземпляров.
- Отделяет публичный трафик от приватного (отдавая приватному приоритет)
- Интегрирован и работает с другими сервисами AWS по необходимости
  (EC2, EC2 Auto Scaling Groups, Amazon ECS)

</details>
<br>

[//]:# (What is Health Checks in ELB?)

<details>
    <summary>
        <b><big><big>
            What is Health Checks in ELB?
        </big></big></b>
    </summary>

Проверки работоспособности имеют решающее значение для балансировщиков нагрузки.
Они позволяют балансировщику нагрузки узнать, на какие экземпляры он перенаправляет трафик.

Проверка работоспособности выполняется для порта и маршрута (/health является общим)
Если ответ не 200 (ОК), экземпляр неисправен.
И трафик прекращается для этого экземпляра распределяясь дальше

</details>
<br>

[//]:# (Types of load balancer on AWS?)

<details>
    <summary>
        <b><big><big>
            Types of load balancer on AWS?
        </big></big></b>
    </summary>

**AWS предлагает 4 типа управляемых балансировщиков нагрузки.**

1) **Classic Load Balancer (CLB)** (v1 — старое поколение) — 2009 г.
HTTP, HTTPS, TCP, SSL (защищенный TCP)

2) **Application Load Balancer (ALB)** (v2 — новое поколение) — 2016
HTTP, HTTPS, веб-сокет

3) **Network Load Balancer (NLB)** (v2 — новое поколение) — 2017
 TCP, TLS (защищенный TCP), UDP

4) **Gateway Load Balancer (GWLB)** — 2020
Работает на уровне 3 (сетевой уровень) – IP-протокол

В целом **рекомендуется** использовать балансировщики нагрузки нового поколения (2,3,4), поскольку они
предоставить больше возможностей

Некоторые балансировщики нагрузки можно настроить как внутренние 
(частные) или внешние (общедоступные) ELB.

</details>
<br>

[//]:# (Explain work of the ALB?)

<details>
    <summary>
        <b><big><big>
            Explain work of the Application Load balancer (ALB)?
        </big></big></b>
    </summary>

Балансировщик нагрузки приложений (v2)

Появилась возможность объединять инстансы в группы, к которым ALB будет роутится
с помощью определенный правил

**Правила маршрутизации:**
- Маршрутизация на основе пути в URL (example.com/users и example.com/posts).
- Маршрутизация на основе имени хоста в URL (one.example.com и other.example.com)
- Маршрутизация на основе строки запроса, заголовков (example.com/users?id=123&order=false)
- ALB отлично подходят для микросервисов и приложений на основе контейнеров.
(пример: Docker и Amazon ECS)
- Имеет функцию сопоставления портов для перенаправления на динамический порт в ECS.

**На что стоит обратить пристальное внимание**

Сервисы которые обрабатывают запрос приходящий от клиента (и распределенный с помощью ALB)
не видят конечного хоста пользователя, поскольку ALB перемещает эту информацию в заголовки 
запроса

- Истинный IP клиента вставлен в заголовок **X-Forwarded-For**
- Порт **X-Forwarded-Port**
- Прото* **X-Forwarded-Proto**

</details>
<br>

[//]:# (Explain work of the NLB?)

<details>
    <summary>
        <b><big><big>
            Explain work of the Network Load Balancer (NLB)?
        </big></big></b>
    </summary>

Балансировщики сетевой нагрузки (уровень 4) позволяют:
- Перенаправлять трафик TCP и UDP на ваши экземпляры.
- Обрабатывать миллионы запросов в секунду
- Меньшая задержка ~100 мс (по сравнению с 400 мс для ALB)
- NLB имеет один статический IP-адрес на каждую зону доступности 
  и поддерживает назначение эластичных IP-адресов.
  (полезно для внесения в белый список определенных IP-адресов)
- NLB используется для максимальной производительности, трафика TCP или UDP.
- Не входит в уровень бесплатного пользования AWS.

В качестве маски перенаправления используются TCP и HTTP хосты (TCP + Rules)

NLB тоже конектится к ожидающим его группам, а именно:
- к группе EC2 машин (объединенных в группу по их именам)
- к группе машин объединенных группой приватных IP
- к включенному ALB

</details>
<br>

[//]:# (Explain work of the GWLB?)

<details>
    <summary>
        <b><big><big>
            Explain work of the Gateway Load Balancer (GWLB)?
        </big></big></b>
    </summary>

GWLB пригодиться нам в случае если нам необходимо перед тем как конечная точка (Ec2)
получит запрос от пользователя, дополнительно пропустить его через сторонние 
прокси инстансы (ec2). Это может быть проверка безопасности, таргетинт, секьюири и т.д. 

![](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2021/07/08/Screen-Shot-2021-07-08-at-12.39.00-PM.png)

</details>
<br>

[//]:# (What is Sticky Sessions [Session Affinity]?)

<details>
    <summary>
        <b><big><big>
            What is Sticky Sessions (Session Affinity)?
        </big></big></b>
    </summary>

AWS ELB предлагает возможность реализации липкости, чт**обы
один и тот же клиент всегда перенаправляется на один и тот же
экземпляр** за балансировщиком нагрузки

- Это работает для CLB и ALB
- реализована система через «Файл cookie», используемый для прилипания, 
  имеющий срок годности, который вы контролируете

**Включение липкости может привести к дисбалансу загружать серверные экземпляры EC2**

**Куки деляться на два типа**
1) Файлы cookie на основе приложений (Application Based)
   - Может включать любые настраиваемые атрибуты, требуемые приложением.
   - Имя файла cookie должно быть указано индивидуально для каждой целевой группы. 
     (Это значит что если пользователь каким-то образом попадет в другую целевую группу,
     прописанные куки могут не работать)
   - Не используйте AWSALB, AWSALBAPP или AWSALBTG (зарезервировано для использования ELB).

2) Файлы cookie на основе продолжительности
    - Файл cookie, созданный балансировщиком нагрузки.
    - Имя файла cookie: AWSALB для ALB, AWSELB для CLB.

</details>
<br>

[//]:# (What is Cross-Zone Load Balancing?)

<details>
    <summary>
        <b><big><big>
            What is Cross-Zone Load Balancing?
        </big></big></b>
    </summary>

**С Cross-zone балансировкой нагрузки:**
- каждый экземпляр балансировщика нагрузки распределяется равномерно
  во всех зарегистрированных экземплярах во всех AZ
  (Это значит что если есть 2 зоны (А и Б) и в зоне А запущено 2 EC2, а в Б 10. 
  И нагрузка на зоны от клиента распределяется пополам (50/50), то не зависимо от этого
  в балансировки будут участвовать все экземпляры во всех зонах)

![](https://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/images/cross_zone_load_balancing_enabled.png)

**Без балансировки нагрузки между зонами:**
- Запросы распределяются по экземплярам только внутри зоны
  (т.е. из ситуации выше. нагрузка 50% на зону А где 2 ec2 будет делится только между экземплярами
  в этой AZ 25/25)

</details>
<br>

[//]:# (What is ELB SSL Certificates?)

<details>
    <summary>
        <b><big><big>
            What is ELB SSL (TLS) Certificates?
        </big></big></b>
    </summary>

**SSL-сертификат разрешает трафик между вашими клиентами, и балансировщиком нагрузки
быть зашифрованным при передаче (шифрование в полете)**
- SSL относится к уровню защищенных сокетов, используемому для шифрования соединений.
- TLS относится к безопасности транспортного уровня, которая является более новой версией.
- В настоящее время в основном используются сертификаты TLS, но люди по-прежнему называют их SSL.
- Публичные SSL-сертификаты выдаются центрами сертификации (CA Certificate Authorities).
- SSL-сертификаты имеют срок действия (устанавливается вами) и должны быть обновлены
- Вы можете управлять сертификатами с помощью ACM (AWS Certificate Manager).
- Клиенты могут использовать SNI (индикатор имени сервера), 
  чтобы указать имя хоста, к которому они обращаются.

**Индикация имени сервера (SNI)**
- SNI решает проблему загрузки нескольких SSL-сертификатов на один веб-сервер
  (для обслуживания нескольких веб-сайтов).
- Это «более новый» протокол, требующий, чтобы клиент
  указал имя хоста целевого сервера в начальном вызове SSL
  После этого сервер найдет правильный сертификат или вернет сертификат по умолчанию
- (**ПРИМЕЧАНИЕ**) Работает только для ALB и NLB (новые поколения), CloudFront

Поэтому если нам нужны мультисертификаты для обращения к нескольким ресурсам
- Необходимо использовать несколько CLB для нескольких имен хостов с несколькими SSL-сертификатами.
- Для новых версий ELB используется индикация имени сервера (SNI)

![](https://miro.medium.com/max/1400/1*wV9ShOOD95MMyXE2fzZ6Lg.png)

</details>
<br>

[//]:# (What is ELB Connection Draining?)

<details>
    <summary>
        <b><big><big>
            What is ELB Connection Draining?
        </big></big></b>
    </summary>

Названия:
- Connection Draining (Слив соединения) - если это CLB
- Deregistration Delay (Задержка отмены регистрации) - если это ALB или NLB

Это функция представляет собой **время для выполнения «запросов в полете»**, пока
экземпляр отменяет регистрацию или неработоспособен. Т.е. в случае какое время ELB
нужно, для того чтобы понять что конечный сервис не доступен и отправлять запросы 
в новый экземпляр ec2.

Эта переменная выставляется от 1 до 3600 секунд (300 (5 минут) - по умолчанию. 0 - отключено)

Если сайту требуется быстрый отклик, устанавливается низкое пороговое значение
(например 30 секунд).

</details>
<br>

[//]:# (What is an ELB Auto Scaling Group?)

<details>
    <summary>
        <b><big><big>
            What is an ELB Auto Scaling Group?
        </big></big></b>
    </summary>

**Цель Auto Scaling Group (ASG):**
- Увеличение масштаба (добавление экземпляров EC2) в соответствии с возросшей нагрузкой.
- Масштабирование (удаление инстансов EC2) в соответствии с уменьшенной нагрузкой.
- Уверенность, что у нас есть минимальное и максимальное количество запущенных экземпляров EC2.
- Автоматически регистрировать новые экземпляры в балансировщике нагрузки.
- Повторное создание экземпляра EC2 в случае прекращения работы предыдущего экземпляра
  (например, если он неработоспособен).

**Очень крутой функцией является масштабировать ASG на основе аварийных сигналов CloudWatch**
- Аварийный сигнал отслеживает метрику (например, среднее значение ЦП или пользовательскую метрику).
- Такие метрики, как средняя загрузка ЦП, рассчитываются для всех экземпляров ASG.
- На основе сигнала тревоги:
  - Можно увеличивать максимальное кол-во инстансов
  - Можно уменьшать максимальное кол-во инстансов

</details>
<br>

[//]:# (What is an ELB Auto Scaling Group?)

<details>
    <summary>
        <b><big><big>
            What is an ELB ASG Dynamic Scaling Policies?
        </big></big></b>
    </summary>

Группы автоматического масштабирования — **политики динамического масштабирования**
- Самый простой и легкий в настройке способ политик расширения инстансов для ASG
  - Например
    - Когда срабатывает сигнал тревоги CloudWatch (например, ЦП > 70%), добавьте 2 единицы.
    - При срабатывании тревоги CloudWatch (например, ЦП < 30%), удалите 1
  - Так же есть запланированные действия
    - Увеличить в 3.00 уменьшить в 13.00
  - Предусмотреть масштабирование на основе известных шаблонов использования.
    - увеличьте минимальную вместимость до 10 в 17:00 по пятницам.

Так же есть функция **прогнозирующее масштабирование**
- На основе данных метрик работы ASG и ELB можно составить полиси с учетом прогноза нагрузки

**Хорошие показатели для масштабирования**
- CPUUtilization: средняя загрузка ЦП. использование в ваших инстансах
- RequestCountPerTarget: чтобы убедиться, количество запросов на EC2 экземпляры стабильны
- Средний сетевой вход/выход (если ваше приложение привязано к сети)
- Любая пользовательская метрика (которую вы получили с помощью CloudWatch)

**После масштабирования срабатывает период восстановления (cool-down) (по умолчанию 300 секунд)**.
В течение периода восстановления ASG не будет запускать и не прекращать дополнительные
экземпляры (чтобы метрики стабилизировались)

</details>
<br>
